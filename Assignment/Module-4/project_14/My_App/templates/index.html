<!DOCTYPE html>
<html>

<head>
    <title>Doctor Profiles (AJAX CRUD)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body class="p-5 container">

    <h2 class="mb-4">Doctor Management (AJAX CRUD)</h2>

    <!-- Add Doctor Form -->
    <div class="card p-3 mb-4">
        <h4>Add Doctor</h4>
        <input type="text" id="name" class="form-control mb-2" placeholder="Name">
        <input type="text" id="specialty" class="form-control mb-2" placeholder="Specialty">
        <input type="text" id="phone" class="form-control mb-2" placeholder="Phone">
        <button id="addBtn" class="btn btn-primary">Add Doctor</button>
    </div>

    <!-- Doctor Table -->
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Name</th>
                <th>Specialty</th>
                <th>Phone</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="doctorTable">
            {% for d in doctors %}
            <tr id="row-{{ d.id }}">
                <td>{{ d.name }}</td>
                <td>{{ d.specialty }}</td>
                <td>{{ d.phone }}</td>
                <td>
                    <button class="btn btn-sm btn-warning editBtn" data-id="{{ d.id }}" data-name="{{ d.name }}"
                        data-specialty="{{ d.specialty }}" data-phone="{{ d.phone }}">Edit</button>

                    <button class="btn btn-sm btn-danger deleteBtn" data-id="{{ d.id }}">Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content p-3">
                <h4>Edit Doctor</h4>

                <input type="hidden" id="edit_id">

                <input type="text" id="edit_name" class="form-control mb-2">
                <input type="text" id="edit_specialty" class="form-control mb-2">
                <input type="text" id="edit_phone" class="form-control mb-2">

                <button id="updateBtn" class="btn btn-success">Update</button>
            </div>
        </div>
    </div>

    <script>
        function getCSRFToken() {
            return document.cookie.split('; ')
                .find(row => row.startsWith('csrftoken'))
                ?.split('=')[1];
        }

        // ADD DOCTOR
        $("#addBtn").click(function () {
            $.ajax({
                url: "/add_doctor/",
                method: "POST",
                data: {
                    name: $("#name").val(),
                    specialty: $("#specialty").val(),
                    phone: $("#phone").val(),
                    csrfmiddlewaretoken: getCSRFToken()
                },
                success: function (res) {
                    $("#doctorTable").append(`
                <tr id="row-${res.id}">
                    <td>${res.name}</td>
                    <td>${res.specialty}</td>
                    <td>${res.phone}</td>
                    <td>
                        <button class="btn btn-sm btn-warning editBtn"
                            data-id="${res.id}"
                            data-name="${res.name}"
                            data-specialty="${res.specialty}"
                            data-phone="${res.phone}">Edit</button>

                        <button class="btn btn-sm btn-danger deleteBtn" data-id="${res.id}">Delete</button>
                    </td>
                </tr>
            `);
                }
            });
        });

        // OPEN EDIT MODAL
        $(document).on("click", ".editBtn", function () {
            $("#edit_id").val($(this).data("id"));
            $("#edit_name").val($(this).data("name"));
            $("#edit_specialty").val($(this).data("specialty"));
            $("#edit_phone").val($(this).data("phone"));

            $("#editModal").modal("show");
        });

        // UPDATE DOCTOR
        $("#updateBtn").click(function () {
            let id = $("#edit_id").val();

            $.ajax({
                url: `/edit_doctor/${id}/`,
                method: "POST",
                data: {
                    name: $("#edit_name").val(),
                    specialty: $("#edit_specialty").val(),
                    phone: $("#edit_phone").val(),
                    csrfmiddlewaretoken: getCSRFToken()
                },
                success: function (res) {
                    $(`#row-${id}`).html(`
                <td>${res.name}</td>
                <td>${res.specialty}</td>
                <td>${res.phone}</td>
                <td>
                    <button class="btn btn-sm btn-warning editBtn"
                        data-id="${res.id}"
                        data-name="${res.name}"
                        data-specialty="${res.specialty}"
                        data-phone="${res.phone}">Edit</button>

                    <button class="btn btn-sm btn-danger deleteBtn" data-id="${res.id}">Delete</button>
                </td>
            `);

                    $("#editModal").modal("hide");
                }
            });
        });

        // DELETE DOCTOR
        $(document).on("click", ".deleteBtn", function () {
            let id = $(this).data("id");

            $.ajax({
                url: `/delete_doctor/${id}/`,
                method: "POST",
                data: {
                    csrfmiddlewaretoken: getCSRFToken()
                },
                success: function (res) {
                    if (res.success) {
                        $(`#row-${id}`).remove();
                    }
                }
            });
        });
    </script>

    <!-- Bootstrap Modal JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>

</html>